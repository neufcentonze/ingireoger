<head>
  <!-- Autres liens et scripts -->
  <script src="https://unpkg.com/lucide@latest/dist/lucide.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      lucide.createIcons();
    });
  </script>
</head>

<h2
  style="color: #fff; margin-left: 20px; display: flex; align-items: center; font-size: 18px; margin-top: 10px; margin-bottom: -5px;">
  <i data-lucide="gift" style="margin-right: 10px;"></i>
  Promotions
</h2>
<section class="promotions-wrapper">
  <div class="promotions-scroll-container fixed-width" id="promoScroll">
    <% const promos=[ { label: "Offre d'inscription" , title: "ðŸ’¸ Votre premier dÃ©pÃ´t est doublÃ© !" ,
      desc: "Votre 1er dÃ©pÃ´t doublÃ© jusqu'Ã  250 â‚¬" , img: "/images/vault.png" }, { label: "Promotion" ,
      title: "ðŸ’¥ Surpasse les autres au classement" , desc: "Jusqu'Ã  3 000 â‚¬ en jeu chaque semaine" ,
      img: "/images/trophee.png" }, { label: "Tirage au sort" , title: "ðŸŽ« Chaque mise peut tout changer" ,
      desc: "10 000 â‚¬ Ã  gagner chaque mois !" , img: "/images/giveaway.png" }, ]; %>

      <% promos.forEach(promo=> { %>
        <div class="promo-card">
          <div class="promo-text">
            <span class="promo-label">
              <%= promo.label %>
            </span>
            <h3>
              <%= promo.title %>
            </h3>
            <p>
              <%= promo.desc %>
            </p>
            <button class="promo-btn">Voir</button>
          </div>
          <div class="promo-img">
            <img src="<%= promo.img %>" alt="Promotion">
          </div>
        </div>
        <% }) %>
  </div>

  <!-- FlÃ¨ches -->
  <button class="arrow left" id="leftArrow">&#10094;</button>
  <button class="arrow right" id="rightArrow">&#10095;</button>
</section>

<h2
  style="color: #fff; margin-left: 20px; display: flex; align-items: center; font-size: 18px; margin-top: 10px; margin-bottom: -5px;">
  <i data-lucide="flame" style="margin-right: 10px;"></i>
  Djelo Games
</h2>
<section class="games-carousel">
  <% games.forEach(game=> { %>
    <div class="game-card" style="position: relative;">
      <a href="/game/<%= game.name %>">
        <img src="<%= game.image %>" alt="<%= game.name %>" style="border-radius: 10px;">
      </a>
      <h3 style="color: #fff; margin-left: 1px; font-size: 14px; text-align: left;">
        <%= game.name %>
      </h3>
    </div>
    <% }) %>
</section>

<h2
  style="color: #fff; margin-left: 20px; display: flex; align-items: center; font-size: 18px; margin-top: 10px; margin-bottom: -5px;">
  <i data-lucide="gift" style="margin-right: 10px;"></i>
  Transactions
</h2>

<div class="transactions-table" id="transactionTableStyled">
  <div class="table-header">
    <div>Jeu</div>
    <div class="mobile-hide">Utilisateur</div>
    <div class="mobile-hide">Temps</div>
    <div class="mobile-hide">Pari</div>
    <div>Multi</div>
    <div>Paiement</div>
  </div>
</div>


<div style="height: 10vh; background: transparent;"></div>
<div style="height: 200px;"></div>

<script>
  const socket = io();

  socket.on('connect', () => {
    console.log('ConnectÃ© au serveur Socket.IO');
  });

  socket.on('initialTransactions', (transactions) => {
    console.log('Transactions initiales reÃ§ues:', transactions);
    transactions.forEach(transaction => {
      addTransaction(transaction.game, transaction.user, transaction.time, transaction.betAmount, transaction.multiplier, transaction.payout);
    });
  });

  socket.on('newTransaction', (transaction) => {
    console.log('Nouvelle transaction reÃ§ue:', transaction);
    addTransaction(transaction.game, transaction.user, transaction.time, transaction.betAmount, transaction.multiplier, transaction.payout);
  });

  document.getElementById('leftArrow').addEventListener('click', () => {
    const container = document.getElementById('promoScroll');
    container.scrollBy({ left: -300, behavior: 'smooth' });
  });

  document.getElementById('rightArrow').addEventListener('click', () => {
    const container = document.getElementById('promoScroll');
    container.scrollBy({ left: 300, behavior: 'smooth' });
  });

  document.addEventListener('DOMContentLoaded', () => {
    const wrapper = document.querySelector('.promotions-wrapper');
    const cards = wrapper?.querySelectorAll('.promo-card');

    if (cards && cards.length <= 3) {
      wrapper.classList.add('no-arrows');
    }
  });

  function addTransaction(game, user, time, betAmount, multiplier, payout) {
    const table = document.getElementById('transactionTableStyled');

    const row = document.createElement('div');
    row.classList.add('table-row');

    row.innerHTML = `
      <div>${game}</div>
      <div class="mobile-hide">${user}</div>
      <div class="mobile-hide">${time}</div>
      <div class="mobile-hide">${formatAmountWithIcon(betAmount)}</div>
      <div>${multiplier}</div>
      <div class="${parseFloat(payout) >= 0 ? 'positive' : 'negative'}">${formatAmountWithIcon(payout)}</div>
    `;
    // Ajoute en haut
    table.insertBefore(row, table.children[1]);

    // Garde seulement les 10 derniers
    const rows = table.querySelectorAll('.table-row');
    if (rows.length > 10) {
      table.removeChild(rows[rows.length - 1]);
    }
  }

  function formatAmountWithIcon(amountStr) {
    let [value, currency] = amountStr.split(" ");
    const iconPath = `/images/${currency}.` + (currency === "eth" ? "svg" : "png");

    const isNegative = value.startsWith("-");
    value = value.replace("-", "");

    return `
    ${isNegative ? '-' : ''}
    ${value}
    <img src="${iconPath}" alt="${currency}" style="width: 16px; vertical-align: middle; margin-left: 4px;">
  `;
  }

</script>