<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
    <%= title || "Djelo" %>
  </title>

  <!-- Styles -->
  <link rel="stylesheet" href="/style/main.css" />
  <link rel="stylesheet" href="/style/header.css" />
  <link rel="stylesheet" href="/style/sidebar.css" />
  <link rel="stylesheet" href="/style/modals.css" />
  <% if (showFooter) { %>
    <link rel="stylesheet" href="/style/footer.css" />
    <% } %>

      <!-- Ic么nes Lucide -->
      <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
  <!--  HEADER -->
  <%- include('../partials/header') %>

    <!-- П WRAPPER PRINCIPAL -->
    <main class="main-wrapper">
      <!--  SIDEBAR -->
      <%- include('../partials/sidebar') %>

        <!--  CONTENU -->
        <div class="main-content">
          <%- body %>

            <!--  Scroll technique mobile -->
            <div style="height: 150vh; background: transparent;"></div>
            <div style="height: 300px;"></div>
        </div>
    </main>

    <!-- 猬锔 FOOTER -->
    <% if (showFooter) { %>
      <%- include('../partials/footer') %>
        <% } %>

          <!--  LOGIN MODAL -->
          <%- include('../partials/modal', { id: 'loginModal' , title: 'Connexion' , width: '350px' ,
            rawLogo: '<i data-lucide="key-round"></i>' , body: ` <form id="loginForm">
            <input type="email" name="email" placeholder="Email" required />
            <input type="password" name="password" placeholder="Mot de passe" required />
            <button type="submit">Se connecter</button>
            </form>
            <div id="loginMsg" class="modal-msg"></div>
            `
            }) %>

            <!--  REGISTER MODAL -->
            <%- include('../partials/modal', { id: 'registerModal' , title: 'Inscription' , width: '350px' ,
              rawLogo: '<i data-lucide="key-round"></i>' , body: ` <form id="registerForm">
              <input type="email" name="email" placeholder="Email" required />
              <input type="text" name="username" placeholder="Nom d'utilisateur" required />
              <input type="password" name="password" placeholder="Mot de passe" required />
              <button type="submit">S'inscrire</button>
              </form>
              <div id="registerMsg" class="modal-msg"></div>
              `
              }) %>

              <!--  JS LOGIQUE UI -->
              <script>
                function isMobile() {
                  return window.innerWidth <= 768;
                }

                document.addEventListener('DOMContentLoaded', () => {
                  const sidebar = document.querySelector('.sidebar');
                  const toggleSidebarBtn = document.getElementById('toggleSidebar');

                  if (isMobile()) {
                    sidebar?.classList.add('sidebar--collapsed');
                  }

                  toggleSidebarBtn?.addEventListener('click', () => {
                    if (isMobile()) {
                      sidebar?.classList.toggle('hidden-mobile');
                    } else {
                      sidebar?.classList.toggle('sidebar--collapsed');
                    }
                  });

                  document.querySelectorAll('.sidebar-toggle').forEach(el => {
                    el.addEventListener('click', (e) => {
                      const id = el.dataset.id;
                      const link = el.dataset.link;

                      if (isMobile()) {
                        window.location.href = link;
                        return;
                      }

                      if (sidebar.classList.contains('sidebar--collapsed')) {
                        sidebar.classList.remove('sidebar--collapsed');
                        setTimeout(() => {
                          document.getElementById('submenu-' + id)?.classList.toggle('open');
                          el.closest('.sidebar-section')?.classList.toggle('open');
                        }, 150);
                      } else {
                        document.getElementById('submenu-' + id)?.classList.toggle('open');
                        el.closest('.sidebar-section')?.classList.toggle('open');
                      }

                      e.preventDefault();
                    });
                  });

                  const footer = document.querySelector('.footer-bloc');
                  if (footer) {
                    window.addEventListener('scroll', () => {
                      const atBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 80;
                      footer.classList.toggle('visible', atBottom);
                    });
                  }
                });
              </script>

              <script>
                lucide.createIcons();
              </script>

              <!--  Modal logic -->
              <script>
                function openModal(id) {
                  document.getElementById(id).style.display = 'block';
                }

                function closeModal(id) {
                  document.getElementById(id).style.display = 'none';
                }

                document.getElementById("openLogin")?.addEventListener("click", (e) => {
                  e.preventDefault();
                  openModal("loginModal");
                });

                document.getElementById("openRegister")?.addEventListener("click", (e) => {
                  e.preventDefault();
                  openModal("registerModal");
                });

                // Login handler
                document.getElementById("loginForm")?.addEventListener("submit", async (e) => {
                  e.preventDefault();
                  const data = {
                    email: e.target.email.value,
                    password: e.target.password.value
                  };
                  const res = await fetch("/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                  });
                  const result = await res.json();
                  document.getElementById("loginMsg").innerText = result.message;
                  if (result.success) setTimeout(() => location.reload(), 1000);
                });

                // Register handler
                document.getElementById("registerForm")?.addEventListener("submit", async (e) => {
                  e.preventDefault();

                  const email = e.target.email.value.trim();
                  const username = e.target.username.value.trim();
                  const password = e.target.password.value;

                  try {
                    const res = await fetch("/auth/register", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ email, username, password })
                    });

                    const result = await res.json();
                    showMessage("registerMsg", result.message, result.success);

                    if (result.success) setTimeout(() => location.reload(), 1000);
                  } catch (err) {
                    showMessage("registerMsg", "Erreur inconnue", false);
                  }
                });
              </script>

              <script>
                function handleSoldeClick(el) {
                  const chevron = el.querySelector('.solde-chevron');
                  const isOpen = chevron.getAttribute('data-lucide') === 'chevron-down';

                  chevron.setAttribute('data-lucide', isOpen ? 'chevron-up' : 'chevron-down');

                  // Met  jour l'ic么ne
                  lucide.createIcons();

                  // Optionnel : toggle dun dropdown, classe .open, etc.
                  el.classList.toggle('open');
                }
              </script>

              <script>
                function toggleSoldeDropdown(el) {
                  const container = el.closest('.solde-container');
                  const isOpen = container.classList.contains('open');

                  // Ferme tous les autres dropdowns
                  document.querySelectorAll('.solde-container.open').forEach(c => c.classList.remove('open'));

                  // Si pas d茅j ouvert, ouvre celui-l
                  if (!isOpen) {
                    container.classList.add('open');
                  }

                  // Change l'ic么ne chevron
                  const chevron = el.querySelector('.solde-chevron');
                  if (chevron) {
                    chevron.setAttribute('data-lucide', isOpen ? 'chevron-down' : 'chevron-up');
                    lucide.createIcons();
                  }
                }

                // Clic en dehors => ferme les dropdowns
                document.addEventListener('click', (e) => {
                  const isInside = e.target.closest('.solde-container');
                  if (!isInside) {
                    document.querySelectorAll('.solde-container.open').forEach(container => {
                      container.classList.remove('open');
                      const chevron = container.querySelector('.solde-chevron');
                      if (chevron) {
                        chevron.setAttribute('data-lucide', 'chevron-down');
                        lucide.createIcons();
                      }
                    });
                  }
                });

                // Clic sur une crypto dans le dropdown => met  jour le haut
                document.querySelectorAll('.solde-option').forEach(option => {
                  option.addEventListener('click', () => {
                    const container = option.closest('.solde-container');
                    const soldeBox = container.querySelector('.solde-box');
                    const newAmount = option.dataset.amount?.slice(0, 10) || '0.00000000';
                    const newIcon = option.dataset.icon || '/images/btc.png';

                    soldeBox.querySelector('.solde-amount').textContent = newAmount;
                    soldeBox.querySelector('.solde-crypto-icon').src = newIcon;

                    container.classList.remove('open');

                    const chevron = soldeBox.querySelector('.solde-chevron');
                    if (chevron) {
                      chevron.setAttribute('data-lucide', 'chevron-down');
                      lucide.createIcons();
                    }
                  });
                });

                // D茅tails (placeholder futur modal)
                function openSoldeDetailsModal() {
                  alert("Ouverture du modal d茅tails bient么t dispo !");
                }
              </script>

              <script src="/js/showMessage.js"></script>
</body>

</html>