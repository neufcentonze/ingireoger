<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
    <%= title || "Djelo" %>
  </title>

  <!-- Styles -->
  <link rel="stylesheet" href="/style/main.css" />
  <link rel="stylesheet" href="/style/header.css" />
  <link rel="stylesheet" href="/style/sidebar.css" />
  <link rel="stylesheet" href="/style/modals.css" />
  <% if (showFooter) { %>
    <link rel="stylesheet" href="/style/footer.css" />
    <% } %>

      <!-- Icônes Lucide -->
      <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
  <!-- 🔝 HEADER -->
  <%- include('../partials/header') %>

    <!-- 🧱 WRAPPER PRINCIPAL -->
    <main class="main-wrapper">
      <!-- 📂 SIDEBAR -->
      <%- include('../partials/sidebar') %>

        <!-- 📦 CONTENU -->
        <div class="main-content">
          <%- body %>

            <!-- 👇 Scroll technique mobile -->
            <div style="height: 150vh; background: transparent;"></div>
            <div style="height: 300px;"></div>
        </div>
    </main>

    <!-- ⬇️ FOOTER -->
    <% if (showFooter) { %>
      <%- include('../partials/footer') %>
        <% } %>

          <!-- 🔐 LOGIN MODAL -->
          <%- include('../partials/modal', { id: 'loginModal' , title: 'Connexion' , width: '350px' ,
            rawLogo: '<i data-lucide="key-round"></i>' , body: ` <form id="loginForm">
            <input type="email" name="email" placeholder="Email" required />
            <input type="password" name="password" placeholder="Mot de passe" required />
            <button type="submit">Se connecter</button>
            </form>
            <div id="loginMsg" class="modal-msg"></div>
            `
            }) %>

            <!-- 📝 REGISTER MODAL -->
            <%- include('../partials/modal', { id: 'registerModal' , title: 'Inscription' , width: '350px' ,
              rawLogo: '<i data-lucide="key-round"></i>' , body: ` <form id="registerForm">
              <input type="email" name="email" placeholder="Email" required />
              <input type="text" name="username" placeholder="Nom d'utilisateur" required />
              <input type="password" name="password" placeholder="Mot de passe" required />
              <button type="submit">S'inscrire</button>
              </form>
              <div id="registerMsg" class="modal-msg"></div>
              `
              }) %>

              <!-- 🔧 JS LOGIQUE UI -->
              <script>
                function isMobile() {
                  return window.innerWidth <= 768;
                }

                document.addEventListener('DOMContentLoaded', () => {
                  const sidebar = document.querySelector('.sidebar');
                  const toggleSidebarBtn = document.getElementById('toggleSidebar');

                  if (isMobile()) {
                    sidebar?.classList.add('sidebar--collapsed');
                  }

                  toggleSidebarBtn?.addEventListener('click', () => {
                    if (isMobile()) {
                      sidebar?.classList.toggle('hidden-mobile');
                    } else {
                      sidebar?.classList.toggle('sidebar--collapsed');
                    }
                  });

                  document.querySelectorAll('.sidebar-toggle').forEach(el => {
                    el.addEventListener('click', (e) => {
                      const id = el.dataset.id;
                      const link = el.dataset.link;

                      if (isMobile()) {
                        window.location.href = link;
                        return;
                      }

                      if (sidebar.classList.contains('sidebar--collapsed')) {
                        sidebar.classList.remove('sidebar--collapsed');
                        setTimeout(() => {
                          document.getElementById('submenu-' + id)?.classList.toggle('open');
                          el.closest('.sidebar-section')?.classList.toggle('open');
                        }, 150);
                      } else {
                        document.getElementById('submenu-' + id)?.classList.toggle('open');
                        el.closest('.sidebar-section')?.classList.toggle('open');
                      }

                      e.preventDefault();
                    });
                  });

                  const footer = document.querySelector('.footer-bloc');
                  if (footer) {
                    window.addEventListener('scroll', () => {
                      const atBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 80;
                      footer.classList.toggle('visible', atBottom);
                    });
                  }
                });
              </script>

              <script>
                lucide.createIcons();
              </script>

              <!-- 🔁 Modal logic -->
              <script>
                function openModal(id) {
                  document.getElementById(id).style.display = 'block';
                }

                function closeModal(id) {
                  document.getElementById(id).style.display = 'none';
                }

                document.getElementById("openLogin")?.addEventListener("click", (e) => {
                  e.preventDefault();
                  openModal("loginModal");
                });

                document.getElementById("openRegister")?.addEventListener("click", (e) => {
                  e.preventDefault();
                  openModal("registerModal");
                });

                // Login handler
                document.getElementById("loginForm")?.addEventListener("submit", async (e) => {
                  e.preventDefault();
                  const data = {
                    email: e.target.email.value,
                    password: e.target.password.value
                  };
                  const res = await fetch("/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                  });
                  const result = await res.json();
                  document.getElementById("loginMsg").innerText = result.message;
                  if (result.success) setTimeout(() => location.reload(), 1000);
                });

                // Register handler
                document.getElementById("registerForm")?.addEventListener("submit", async (e) => {
                  e.preventDefault();
                  const data = {
                    email: e.target.email.value,
                    username: e.target.username.value,
                    password: e.target.password.value
                  };
                  const res = await fetch("/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                  });
                  const result = await res.json();
                  document.getElementById("registerMsg").innerText = result.message;
                  if (result.success) setTimeout(() => location.reload(), 1000);
                });
              </script>
</body>

</html>